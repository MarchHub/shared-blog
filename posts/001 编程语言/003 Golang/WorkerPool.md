---
title: WorkerPool
tags: []
date: 2025-08-09
---
# WorkerPool

å·¥ä½œæ± ï¼Œä¸€ç§å¹¶å‘è®¾è®¡ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªä¸»è¦æ¦‚å¿µ
- å·¥äººï¼šå¹²å·¥ä½œçš„å·¥äºº
- å·¥ä½œï¼šåˆ†é…çš„ä»»åŠ¡

## ç®€å•å®ç°

```go
type Job struct {
Â  Â  Id Â  int
Â  Â  Data string
}

func Worker(id int, tasks chan Job, wg *sync.WaitGroup) {
Â  Â  defer wg.Done()
Â  Â  for t := range tasks {
Â  Â  Â  Â  fmt.Printf("Worker %d processing task %d, and data %s\n", id, t.Id, t.Data)
Â  Â  Â  Â  time.Sleep(time.Millisecond * 50)
Â  Â  }
}

func main() {
Â  Â  const POOLSIZE = 5
Â  Â  tasks := make(chan Job, 10)
Â  Â  var wg sync.WaitGroup

Â  Â  for i := 1; i <= POOLSIZE; i++ {
Â  Â  Â  Â  wg.Add(1)
Â  Â  Â  Â  go Worker(i, tasks, &wg)
Â  Â  }
Â  Â  
Â  Â  for i := 1; i <= 50; i++ {
Â  Â  Â  Â  tasks <- Job{
Â  Â  Â  Â  Â  Â  Id: Â  i,
Â  Â  Â  Â  Â  Â  Data: fmt.Sprintf("payload-%d", i),
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  close(tasks)
Â  Â  wg.Wait()
Â  Â  fmt.Println("all tasks done")
}
```

é¦–å…ˆ`Job`ç»“æ„ä½“å®šä¹‰äº†ä»»åŠ¡æ‰€éœ€è¦çš„æ•°æ®ï¼›
`Worker`å‡½æ•°å®šä¹‰äº†â€œå·¥äººâ€å…·ä½“çš„æ“ä½œè¡Œä¸ºï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª`WaitGroup`æ¥å­˜æ”¾æ‰€æœ‰çš„å·¥äººï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨æ‰€æœ‰çš„å¹¶å‘ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼›

æ‰§è¡Œé€»è¾‘ï¼š
1. åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å·¥ä½œæ± ï¼Œå¹¶ä¸”æœ‰äº”ä¸ªæ‰§è¡Œä»»åŠ¡çš„â€œå·¥äººâ€
2. åˆ©ç”¨é€šé“æ— æ•°æ®çš„é˜»å¡ï¼Œä½¿å¾—ä»–ä»¬åœ¨ç­‰å¾…é€šé“ä¼ è¾“ä»»åŠ¡
3. åœ¨ä¸»çº¿ç¨‹ä¸­æˆ‘ä»¬é€šè¿‡åˆ›å»º`Job`å¹¶ä¸”å†™å…¥ä»»åŠ¡é€šé“ã€‚
4. ä»»åŠ¡é€šé“æœ‰äº†ä»»åŠ¡ï¼Œå·¥ä½œæ± ä¸­å¼€å§‹æ­£å¸¸å·¥ä½œ

## æ³¨æ„ç‚¹

### éå†é€šé“

`for t := range tasks` ä¼šä¸€ç›´è¯»å–é€šé“`tasks`ä¸­çš„å†…å®¹ï¼Œå› ä¸ºå®ƒçš„æœ¬è´¨ä¹Ÿæ˜¯`t := <- tasks`ï¼Œæ‰€ä»¥é˜»å¡æƒ…å†µå’Œæ™®é€šçš„ä»é€šé“ä¸­è¯»å–æ•°æ®æ²¡å·®åˆ«ã€‚
ä½†æ˜¯ï¼Œå½“éå†ä¸€ä¸ªæœ‰ç¼“å·²å…³é—­çš„é€šé“ï¼Œä¼š==æ¥æ”¶é€šé“å†…æ‰€æœ‰çš„ç¼“å­˜æ•°æ®==ï¼Œç„¶åè¿”å›ã€‚

### WaitGroup

å¦‚æœä¸å…ˆå…³é—­é€šé“ï¼Œç›´æ¥`wg.Wait()`ä¼šå› ä¸º`for t := range tasks`ä¸€ç›´é˜»å¡è€Œé€ æˆæ­»é”ğŸ’¦
